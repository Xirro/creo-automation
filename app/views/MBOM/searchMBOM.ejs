<!DOCTYPE html>
<html lang="en" data-debug="<%= debug ? 'true' : 'false' %>">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
    <title><%= title %></title>
    <meta content="Quote Detail" name="SAI-APS-Portal" />
    <link rel="shortcut icon" href="/public/assets/images/SAI-Logo.JPG">
    <link rel="stylesheet" href="/public/plugins/morris/morris.css">

    <link href="/public/plugins/RWD-Table-Patterns/dist/css/rwd-table.min.css" rel="stylesheet" type="text/css" media="screen" />
    <link href="/public/plugins/bootstrap-colorpicker/css/bootstrap-colorpicker.min.css" rel="stylesheet" />
    <link href="/public/plugins/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css" rel="stylesheet" />
    <link href="/public/plugins/select2/css/select2.min.css" rel="stylesheet" type="text/css" />
    <link href="/public/plugins/bootstrap-touchspin/css/jquery.bootstrap-touchspin.min.css" rel="stylesheet" />

    <link href="/public/assets/css/breakerDragDrop.css" rel="stylesheet" type="text/css" />
    <link href="/public/plugins/jquery-ui/jquery-ui.min.css" rel="stylesheet" type="text/css" />
    <!-- ION Slider -->
    <link href="/public/plugins/ion-rangeslider/ion.rangeSlider.css" rel="stylesheet" type="text/css"/>
    <link href="/public/plugins/ion-rangeslider/ion.rangeSlider.skinModern.css" rel="stylesheet" type="text/css"/>

    <link href="/public/assets/css/metismenu.min.css" rel="stylesheet" type="text/css">
    <link href="/public/assets/css/icons.css" rel="stylesheet" type="text/css">
    <link href="/public/assets/css/bootstrap.min.css" rel="stylesheet" type="text/css">
    <link href="/public/assets/css/style.css" rel="stylesheet" type="text/css">
    <link href="/public/assets/css/mbomBrkTable.css" rel="stylesheet" type="text/css">
    <link href="/public/assets/css/mbomShipLoose.css" rel="stylesheet" type="text/css">
    <script>
        document.addEventListener("DOMContentLoaded", function(event) {
            let scrollpos = localStorage.getItem('scrollpos');
            if (scrollpos) window.scrollTo(0, scrollpos);
        });

        window.onbeforeunload = function(e) {
            localStorage.setItem('scrollpos', window.scrollY);
        };
        // expose debug flag to client (read from html `data-debug` attribute)
        window.__DEBUG = document.documentElement.getAttribute('data-debug') === 'true';
    </script>
    <style>
        div{
            overflow: visible !important;
        }
        /* Hide visual sort indicators when table has .sort-hidden, but keep aria-sort for accessibility */
        table.sort-hidden .sort-indicator { visibility: hidden !important; }
    </style>
</head>

<body>
<div id="wrapper">

    <!-- Top Bar Start -->
    <%- include('../partials/header') %>
    <!-- Top Bar End -->

    <!-- ========== Left Sidebar Start ========== -->
    <%- include('../partials/sidebar') %>
    <!-- Left Sidebar End -->

<div class="content-page">
<!-- Content Start -->
<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-12">
                <div class="page-title-box">
                    <h4 class="page-title">Mechanical Engineering - BOM Configure</h4>
                    <div class="row">
                        <div class="col-sm-12">
                            <!--< % include ../Partials/TinyCharts % >-->
                        </div>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-sm-12">
                            <div class="card m-b-20">
                                <div class="card-body">
                                    <h4 class="mt-0 header-title">Current Job</h4>
                                    <form id="jobSelectForm" class="jobSelectForm" action="" method="POST">
                                        <div class="form-group">
                                            <% if(mbomData) { %>
                                                <div class="row">
                                                    <div class="col-sm-1">
                                                        <label for="jobNum" class="col-form-label">Job #</label>
                                                        <input type="text" id="jobNum" name="jobNum" class="form-control" value="<%= mbomData.jobNum %>" placeholder="Type Number Here" readonly="readonly">
                                                    </div>
                                                    <div class="col-sm-1">
                                                        <label for="releaseNum" class="col-form-label">Release</label>
                                                        <input type="text" id="releaseNum" name="releaseNum" class="form-control" value="<%= mbomData.releaseNum %>" placeholder="Type Release Here" readonly="readonly">
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <label for="" class="col-form-label">Job Name</label>
                                                        <input type="text" name="jobName" class="form-control" value="<%= mbomData.jobName %>" placeholder="Type Name Here" id="jobName" readonly="readonly">
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <label for="" class="col-form-label">Customer</label>
                                                        <input type="text" name="customer" class="form-control" value="<%= mbomData.customer %>" placeholder="Type Customer Here" id="customer" readonly="readonly">
                                                    </div>
                                                    <div class="col-sm-4">
                                                        <label for="" class="col-form-label">Board Designation</label>
                                                        <input type="text" name="boardDesignation" class="form-control" value="<%= mbomData.boardDesignation %>" placeholder="Type Designation Here" id="boardDesignation" readonly="readonly">
                                                    </div>
                                                </div>
                                            <div class="row justify-content-center">
                                                <div class="col-sm-1" style="margin-top: 1%;">
                                                    <% if (mbomData.noSectionMBOM == 'N') { %>
                                                        <input class="form-check-input" type="checkbox" value="true" name="noSectionMBOM" id="noSectionMBOM" disabled="disabled">
                                                        <label for="noSectionMBOM" class="form-check-label">No Section MBOM</label>
                                                    <% } else { %>
                                                        <input class="form-check-input" type="checkbox" value="true" name="noSectionMBOM" id="noSectionMBOM" checked="checked" disabled="disabled">
                                                        <label for="noSectionMBOM" class="form-check-label">No Section MBOM</label>
                                                    <% } %>
                                                </div>
                                            </div>
                                            <% } %>
                                        </div>
                                    </form>
                                    <div class="row justify-content-center">
                                        <div class="col-2">
                                            <input id="editMbomButton" type="button" value="Edit" class="btn-block btn-lg btn-outline-warning waves-effect waves-light" data-toggle="modal" data-target="#editMbomModal"/>
                                            <!-- Modal -->
                                            <div class="modal fade" id="editMbomModal" tabindex="-1" role="dialog" aria-labelledby="editMbomModalTitle" aria-hidden="true">
                                                <div class="modal-dialog modal-dialog-centered" role="document">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title" id="editMbomModalTitle">Edit MBOM</h5>
                                                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                <span aria-hidden="true">&times;</span>
                                                            </button>
                                                        </div>
                                                        <div class="modal-body">
                                                            <form id="editMbomForm" class="editMbomForm" action="../editMBOM/?mbomID=<%= mbomID %>" method="POST">
                                                                <div class="form-group">
                                                                    <p class="mb-0">
                                                                        Please fill out the following and click "Save" afterwards
                                                                    </p>
                                                                    <p class="text-muted m-b-5"></p>
                                                                    <div class="row">
                                                                        <div class="col-sm-8">
                                                                            <label for="" class="col-form-label">Job #</label>
                                                                            <input type="text" name="jobNum" class="form-control" value="<%= mbomData.jobNum %>" placeholder="Type Number Here" id="" readonly="readonly">
                                                                        </div>
                                                                        <div class="col-sm-4">
                                                                            <label for="" class="col-form-label">Release</label>
                                                                            <input type="text" name="releaseNum" class="form-control" value="<%= mbomData.releaseNum %>" placeholder="Type Release Here" id="" readonly="readonly">
                                                                        </div>
                                                                    </div>
                                                                    <div class="row">
                                                                        <div class="col-sm-12">
                                                                            <label for="" class="col-form-label">Job Name</label>
                                                                            <input type="text" name="jobName" class="form-control" value="<%= mbomData.jobName %>" placeholder="Type Name Here" id="">
                                                                        </div>
                                                                    </div>
                                                                    <div class="row">
                                                                        <div class="col-sm-12">
                                                                            <label for="" class="col-form-label">Customer</label>
                                                                            <input type="text" name="customer" class="form-control" value="<%= mbomData.customer %>" placeholder="Type Customer Here" id="">
                                                                        </div>
                                                                    </div>
                                                                    <div class="row">
                                                                        <div class="col-sm-12">
                                                                            <label for="" class="col-form-label">Board Designation</label>
                                                                            <input type="text" name="boardDesignation" class="form-control" value="<%= mbomData.boardDesignation %>" placeholder="Type Designation Here" id="">
                                                                        </div>
                                                                    </div>
                                                                    <div class="row justify-content-center">
                                                                        <div class="col-sm-4" style="margin-top:2%;">
                                                                            <% if (mbomData.noSectionMBOM == 'N') { %>
                                                                                <input class="form-check-input" type="checkbox" value="true" name="noSectionMBOM" id="noSectionMBOM">
                                                                                <label for="noSectionMBOM" class="form-check-label">No Section MBOM</label>
                                                                            <% } else { %>
                                                                                <input class="form-check-input" type="checkbox" value="true" name="noSectionMBOM" id="noSectionMBOM" checked="checked">
                                                                                <label for="noSectionMBOM" class="form-check-label">No Section MBOM</label>
                                                                            <% } %>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="modal-footer justify-content-center">
                                                                    <div class="w-50">
                                                                        <% if(mbomData) { %>
                                                                            <input id="editMbomModalButton" type="submit" value="Save" class="btn-block btn-lg btn-info" />
                                                                        <% } %>
                                                                    </div>
                                                                </div>
                                                            </form>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- END MODAL -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="card m-b-20">
                                <div class="card-body">
                                    <h4 class="mt-0 header-title">Section Summary</h4>
                                    <form id="mbomAddSection" class="mbomAddSection" action="" method="POST">
                                        <div class="row">
                                            <% if(mbomData) { %>
                                                <div class="col-sm-12">
                                                    <input type="text" name="jobNum" class="form-control" value="<%= mbomData.jobNum %>" id="jobNum" hidden="hidden">
                                                    <input type="text" name="releaseNum" class="form-control" value="<%= mbomData.releaseNum %>" id="releaseNum" hidden="hidden">
                                                    <input type="text" name="mbomID" class="form-control" value="<%= mbomData.mbomID %>" id="mbomID" hidden="hidden">
                                                    <input type="text" name="jobName" class="form-control" value="<%= mbomData.jobName %>" id="jobName" hidden="hidden">
                                                    <input type="text" name="customer" class="form-control" value="<%= mbomData.customer %>" id="customer" hidden="hidden">
                                                    <input type="text" name="boardDesignation" class="form-control" value="<%= mbomData.boardDesignation %>" id="boardDesignation" hidden="hidden">
                                                    <input type="text" name="numSections" class="form-control" value="<%= mbomData.numSections %>" id="numSections" hidden="hidden">
                                                    <input type="text" name="noSectionMBOM" class="form-control" value="<%= mbomData.noSectionMBOM%>" id="noSectionMBOM" hidden="hidden">
                                                </div>
                                            <% } %>
                                            <div class="col-sm-4 d-flex align-items-end">
                                                <div class="form-group mb-0 mr-2" style="min-width:80px;">
                                                    <label for="addCount" class="col-form-label small mb-1">Qty</label>
                                                    <input id="addCount" name="addCount" type="number" min="1" max="50" step="1" value="1" class="form-control form-control-sm" style="width:72px;" oninput="if(this.value==='')return; if(parseInt(this.value,10)>50) this.value=50; if(parseInt(this.value,10)<1) this.value=1;" />
                                                </div>
                                                <div class="form-group mb-0 mr-2">
                                                    <button id="addSectionBtn" type="submit" class="btn btn-success btn-lg" onclick="this.form.action='/mbomAddSection'">Add Section</button>
                                                </div>
                                                <div class="form-group mb-0">
                                                    <button id="clearAllBtn" type="button" class="btn btn-danger btn-lg" data-toggle="modal" data-target="#resetModal">Clear All</button>
                                                </div>

                                                <!-- Modal -->
                                                <div class="modal fade" id="resetModal" tabindex="-1" role="dialog" aria-labelledby="resetModalTitle" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered" role="document">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="exampleModalLongTitle" style="font-size: x-large">Whoa there...</h5>
                                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                    <span aria-hidden="true">&times;</span>
                                                                </button>
                                                            </div>
                                                            <div class="modal-body text-center" style="font-size: medium">
                                                                Are you sure you want to clear all sections?
                                                            </div>
                                                            <div class="modal-footer justify-content-center">
                                                                <div id="confirmResetForm" class="w-100 d-flex justify-content-center">
                                                                    <% if(mbomData) { %>
                                                                        <input type="hidden" id="confirm_jobNum" value="<%= mbomData.jobNum %>" />
                                                                        <input type="hidden" id="confirm_releaseNum" value="<%= mbomData.releaseNum %>" />
                                                                        <button id="confirmResetBtn" type="button" class="btn btn-secondary" style="border: 0; min-width:120px; margin-right:12px" onclick="(function(){var f=document.getElementById('mbomAddSection'); if(!f) return; f.action='/mbomResetSection'; f.submit();})();">Yes</button>
                                                                    <% } %>
                                                                    <button type="button" class="btn btn-danger" data-dismiss="modal" style="min-width:120px">No</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- END MODAL -->
                                            </div>
                                            <%
                                                let shipLoose = false;
                                                for (let row of (mbomItemData || [])) {
                                                    if (row && row.shipLoose == 'Y') { shipLoose = true; break; }
                                                }
                                            %>
                                            <% if (shipLoose) { %>
                                                <div class="col-sm-3"></div>
                                                <div class="col-sm-5 outerShipLooseDiv" style="padding-top: 1.1rem;">
                                                    <div class="row">
                                                        <div class="col-sm-12 shipLooseHeading">
                                                            <h6>Ship Loose Items</h6>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-sm-12 shipLooseDiv">
                                                            <ul class="shipLooseUL">
                                                                <% for(let row of mbomItemData){ %>
                                                                    <% if(row.shipLoose == 'Y' && row.userItemID == null){ %>
                                                                    <%for(let el of comItemData){ %>
                                                                        <% if(el.comItemID == row.comItemID){%>
                                                                            <li class="shipLooseLI">
                                                                                <span class="badge badge-light"><%= row.itemQty %></span>
                                                                                <%= el.itemDesc %>
                                                                            </li>
                                                                        <% } %>
                                                                    <% } %>
                                                                    <% } else if(row.shipLoose == 'Y' && row.comItemID == null){ %>
                                                                        <% for(let el of userItemData){ %>
                                                                            <% if(el.userItemID == row.userItemID){ %>
                                                                                <li class="shipLooseLI">
                                                                                    <span class="badge badge-light"><%= row.itemQty %></span>
                                                                                    <%= el.itemDesc %>
                                                                                </li>
                                                                            <% } %>
                                                                        <% } %>
                                                                    <% } %>
                                                                <% } %>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            <% } %>
                                        </div>
                                        <div class="row" style="width: 100%; margin-left: .1rem;">
                                            <div class="col-sm-2" style="position: sticky; top: 100px; margin-top: 2rem;">
                                                <h6>Item Queue</h6>
                                                <ol data-draggable="target" id="itemQueue" class="itemQueue" style="width: 100%;">
                                                    <% if(mbomItemData.length != 0){ %>
                                                        <% for(let i = 0; i < mbomItemData.length; i++){ %>
                                                            <% let currentItem = mbomItemData[i].itemSumID; %>
                                                            <% if(mbomSecData.length != 0){ %>
                                                                <% let usedItems = []; %>
                                                                <% if(mbomItemData[i].secID != null){ %>
                                                                    <% usedItems.push(mbomItemData[i].itemSumID); %>
                                                                <% } %>
                                                                <% if(usedItems.includes(currentItem)){ %>
                                                                <% } else { %>
                                                                    <% if(userItemData.length != 0){ %>
                                                                        <% for(let j = 0; j < userItemData.length; j++){ %>
                                                                            <% if(mbomItemData[i].userItemID == userItemData[j].userItemID && mbomItemData[i].shipLoose == 'N'){ %>
                                                                                <li id="I<%= mbomItemData[i].itemSumID%>" data-draggable="item" style="background-color: #c5cd98;">
                                                                                    <span class="badge badge-light"><%= mbomItemData[i].itemQty %></span>
                                                                                    <%= userItemData[j].itemDesc %>
                                                                                </li>
                                                                            <% } %>
                                                                        <% } %>
                                                                    <% } %>
                                                                    <% if(comItemData.length != 0){%>
                                                                        <% for(let j = 0; j < comItemData.length; j++){ %>
                                                                            <% if(mbomItemData[i].comItemID == comItemData[j].comItemID && mbomItemData[i].shipLoose == 'N'){ %>
                                                                                <li id="I<%= mbomItemData[i].itemSumID%>" data-draggable="item" style="background-color: #c5cd98;">
                                                                                    <span class="badge badge-light"><%= mbomItemData[i].itemQty %></span>
                                                                                    <%= comItemData[j].itemDesc %>
                                                                                </li>
                                                                            <% } %>
                                                                        <% } %>
                                                                    <% } %>
                                                                <% } %>
                                                            <% } else { %>
                                                                <%if(userItemData.length != 0){%>
                                                                    <% for(let j = 0; j < userItemData.length; j++){ %>
                                                                        <% if(mbomItemData[i].userItemID == userItemData[j].userItemID && mbomItemData[i].shipLoose == 'N'){ %>
                                                                            <li id="I<%= mbomItemData[i].itemSumID%>" data-draggable="item" style="background-color: #c5cd98;">
                                                                                <span class="badge badge-light"><%= mbomItemData[i].itemQty %></span>
                                                                                <%= userItemData[j].itemDesc %>
                                                                            </li>
                                                                        <% } %>
                                                                    <% } %>
                                                                <% } %>
                                                                <% if(comItemData.length != 0){%>
                                                                    <% for(let j = 0; j < comItemData.length; j++){ %>
                                                                        <% if(mbomItemData[i].comItemID == comItemData[j].comItemID && mbomItemData[i].shipLoose == 'N'){ %>
                                                                            <li id="I<%= mbomItemData[i].itemSumID%>" data-draggable="item" style="background-color: #c5cd98;">
                                                                                <span class="badge badge-light"><%= mbomItemData[i].itemQty %></span>
                                                                                <%= comItemData[j].itemDesc %>
                                                                            </li>
                                                                        <% } %>
                                                                    <% } %>
                                                                <% } %>
                                                            <% } %>
                                                        <% } %>
                                                    <% } %>
                                                </ol>
                                            </div>
                                            <div class="col-sm-2" style="position: sticky; top: 100px; margin-top: 2rem;">
                                                <h6>MCCB Queue</h6>
                                                <ol data-draggable="target" id="mcBrkQueue" class="breakerQueueMC" style="width: 100%;">
                                                    <% if(mbomBrkData.length != 0) { %>
                                                        <% for (let k=0; k < mbomBrkData.length; k++) { %>
                                                            <% let devProduct = (mbomBrkData[k].class).includes("MCCB"); %>
                                                            <% if(devProduct){ %>
                                                                <% var currentMouldedBrk = mbomBrkData[k].idDev; %>
                                                                <% if(mbomSecData.length != 0) { %>
                                                                    <% var usedMouldedBrks = []; %>
                                                                    <% if(mbomBrkData[k].secID != null){ %>
                                                                        <% usedMouldedBrks.push(mbomBrkData[k].idDev); %>
                                                                    <% } %>
                                                                    <% if (usedMouldedBrks.includes(currentMouldedBrk)) { %>
                                                                    <% } else { %>
                                                                        <li id="B<%= mbomBrkData[k].idDev%>" data-draggable="item" style="background-color: #fcca9c;">
                                                                            <%= mbomBrkData[k].devDesignation %>
                                                                        </li>
                                                                    <% } %>
                                                                <% } else { %>
                                                                    <li id="B<%= mbomBrkData[k].idDev%>" data-draggable="item" style="background-color: #fcca9c;">
                                                                        <%= mbomBrkData[k].devDesignation %>
                                                                    </li>
                                                                <% } %>
                                                            <% } %>
                                                        <% } %>
                                                    <% } %>
                                                </ol>
                                                <h6>ICCB Queue</h6>
                                                <ol data-draggable="target" id="icBrkQueue" class="breakerQueueIC" style="width: 100%;">
                                                    <% if(mbomBrkData.length != 0) { %>
                                                        <% for (let k=0; k < mbomBrkData.length; k++) { %>
                                                            <% let devProduct = (mbomBrkData[k].class).includes("ICCB"); %>
                                                            <% if(devProduct){ %>
                                                                <% var currentICBrk = mbomBrkData[k].idDev; %>
                                                                <% if(mbomSecData.length != 0) { %>
                                                                    <% var usedICBrks = []; %>
                                                                    <% if(mbomBrkData[k].secID != null){ %>
                                                                        <% usedICBrks.push(mbomBrkData[k].idDev); %>
                                                                    <% } %>
                                                                    <% if (usedICBrks.includes(currentICBrk)) { %>
                                                                    <% } else { %>
                                                                        <li id="B<%= mbomBrkData[k].idDev%>" data-draggable="item" style="background-color: #b1e7d5;">
                                                                            <%= mbomBrkData[k].devDesignation %>
                                                                        </li>
                                                                    <% } %>
                                                                <% } else { %>
                                                                    <li id="B<%= mbomBrkData[k].idDev%>" data-draggable="item" style="background-color: #b1e7d5;">
                                                                        <%= mbomBrkData[k].devDesignation %>
                                                                    </li>
                                                                <% } %>
                                                            <% } %>
                                                        <% } %>
                                                    <% } %>
                                                </ol>
                                            </div>
                                            <div class="row" style="margin-left: 33.5%; width: 100%; margin-top: -22.1rem">
                                                <% if(mbomData) { %>
                                                    <% for (let i=0; i < mbomData.numSections; i++) { %>
                                                        <div class="col-sm-3">
                                                            <%if( i < 9){%>
                                                            <% let headerSecID = null; for (let sIdx = 0; sIdx < (mbomSecData || []).length; sIdx++) { if (mbomSecData[sIdx].sectionNum == i+1) { headerSecID = mbomSecData[sIdx].secID; break; } } %>
                                                            <% let deleteQuery = headerSecID ? ('secID=' + headerSecID) : ('selectedSec=' + (i+1)); %>
                                                            <h6>Section 10<%=i+1%>
                                                                <input id="deleteSectionBtn" type="submit" value="&times;" class="close" style="margin: -2px 25px auto 25px; border: white; background: white" onclick="this.form.action='../mbomDeleteSection/?<%= deleteQuery %>&numSections=<%= mbomData.numSections%>'" />
                                                            </h6>
                                                            <% } else{ %>
                                                            <% let headerSecID = null; for (let sIdx = 0; sIdx < (mbomSecData || []).length; sIdx++) { if (mbomSecData[sIdx].sectionNum == i+1) { headerSecID = mbomSecData[sIdx].secID; break; } } %>
                                                            <% let deleteQuery = headerSecID ? ('secID=' + headerSecID) : ('selectedSec=' + (i+1)); %>
                                                            <h6>Section 1<%=i+1%>
                                                                <input id="deleteSectionBtn" type="submit" value="&times;" class="close" style="margin: -2px 25px auto 25px; border: white; background: white" onclick="this.form.action='../mbomDeleteSection/?<%= deleteQuery %>&numSections=<%= mbomData.numSections%>'" />
                                                            </h6>
                                                            <% } %>
                                                            <ol data-draggable="target" id="section<%=i+1%>" style="width: 100%;">
                                                                <% if(mbomItemData.length != 0){ %>
                                                                    <% for(let j = 0; j < mbomItemData.length; j++){ %>
                                                                        <% let currentItem = mbomItemData[j].itemSumID; %>
                                                                        <% if(mbomItemData[j].secID != null){ %>
                                                                            <% for(let k = 0; k < mbomSecData.length; k++){  %>
                                                                                <% let usedItems = []; %>
                                                                                <% if(mbomSecData[k].secID == mbomItemData[j].secID){ %>
                                                                                    <% if(mbomSecData[k].sectionNum == i+1){ %>
                                                                                        <% usedItems.push(mbomItemData[j].itemSumID); %>
                                                                                    <% } %>
                                                                                <% } %>
                                                                                <% if(usedItems.includes(currentItem)){ %>
                                                                                    <%if(userItemData.length != 0){%>
                                                                                        <% for(let k = 0; k < userItemData.length; k++){ %>
                                                                                            <% if(mbomItemData[j].userItemID == userItemData[k].userItemID && mbomItemData[j].shipLoose == 'N'){ %>
                                                                                                <li id="I<%= mbomItemData[j].itemSumID%>" data-draggable="item" style="background-color: #c5cd98;">
                                                                                                    <span class="badge badge-light"><%= mbomItemData[j].itemQty %></span>
                                                                                                    <%= userItemData[k].itemDesc %>
                                                                                                </li>
                                                                                            <% } %>
                                                                                        <% } %>
                                                                                    <% } %>
                                                                                    <% if(comItemData.length != 0){%>
                                                                                        <% for(let k = 0; k < comItemData.length; k++){ %>
                                                                                            <% if(mbomItemData[j].comItemID == comItemData[k].comItemID && mbomItemData[j].shipLoose == 'N'){ %>
                                                                                                <li id="I<%= mbomItemData[j].itemSumID%>" data-draggable="item" style="background-color: #c5cd98;">
                                                                                                    <span class="badge badge-light"><%= mbomItemData[j].itemQty %></span>
                                                                                                    <%= comItemData[k].itemDesc %>
                                                                                                </li>
                                                                                            <% } %>
                                                                                        <% } %>
                                                                                    <% } %>
                                                                                <% } %>
                                                                            <% } %>
                                                                        <% } %>
                                                                    <% } %>
                                                                <% } %>
                                                                <% if(mbomBrkData.length != 0) { %>
                                                                    <% for (let j=0; j < mbomBrkData.length; j++) { %>
                                                                        <% let currentBrk = mbomBrkData[j].idDev; %>
                                                                        <% let brkAcc = []; %>
                                                                        <% let brkAccQty = []; %>
                                                                        <% if(mbomBrkData[j].secID != null){ %>
                                                                            <% for (let k=0; k < mbomSecData.length; k++) { %>
                                                                                <% let usedBrks = []; %>
                                                                                <% if(mbomSecData[k].secID == mbomBrkData[j].secID){ %>
                                                                                    <% if(mbomSecData[k].sectionNum == i+1){ %>
                                                                                        <% usedBrks.push(mbomBrkData[j].idDev); %>
                                                                                    <% } %>
                                                                                <% } %>
                                                                                <% if (usedBrks.includes(currentBrk)) { %>
                                                                                    <% for (let x = 0; x < mbomBrkAcc.length; x++) { %>
                                                                                        <% if (mbomBrkAcc[x].idDev == mbomBrkData[j].idDev) { %>
                                                                                            <% brkAcc.push(mbomBrkAcc[x].brkAccDesc); %>
                                                                                            <% brkAccQty.push(mbomBrkAcc[x].brkAccQty); %>
                                                                                        <% } %>
                                                                                    <% } %>
                                                                                    <% let title1 = ''; %>
                                                                                    <% for (let y = 0; y < brkAcc.length; y++) { %>
                                                                                        <% let tempDesc = '('+brkAccQty[y]+')' + ' - ' + brkAcc[y]; %>
                                                                                        <% title1 += tempDesc + '<br>'; %>
                                                                                    <% } %>
                                                                                    <% if(mbomBrkData[j].class.includes('MCCB')){ %>
                                                                                        <li id="B<%= mbomBrkData[j].idDev%>" data-draggable="item" data-toggle="tooltip" data-html="true" title="<%- title1 %>" style="background-color: #fcca9c;">
                                                                                            <%= mbomBrkData[j].devDesignation %>
                                                                                        </li>
                                                                                    <% } else { %>
                                                                                        <li id="B<%= mbomBrkData[j].idDev%>" data-draggable="item" data-toggle="tooltip" data-html="true" title="<%- title1 %>" style="background-color: #b1e7d5;">
                                                                                            <%= mbomBrkData[j].devDesignation %>
                                                                                        </li>
                                                                                    <% } %>
                                                                                <% } %>
                                                                            <% } %>
                                                                        <% } %>
                                                                    <% } %>
                                                                <% } %>
                                                            </ol>
                                                        </div>
                                                    <% } %>
                                                <% } %>
                                            </div>
                                        </div>
                                    </form>
                                    <div class="row justify-content-center">
                                        <div class="col-sm-3">
                                            <label for="" class="col-form-label"></label>
                                            <button id="saveSectionBtn" class="btn-block btn-lg btn-outline-success waves-effect waves-light">Save Changes</button>
                                        </div>
                                        <div class="col-sm-3">
                                            <form id="mbomAddSection" class="mbomAddSection" action="" method="POST">
                                                <% if(mbomData) { %>
                                                    <input type="text" name="jobNum" class="form-control" value="<%= mbomData.jobNum %>" placeholder="Type Number Here" id="" readonly="readonly" hidden="hidden">
                                                    <input type="text" name="releaseNum" class="form-control" value="<%= mbomData.releaseNum %>" placeholder="Type Release Here" id="" readonly="readonly" hidden="hidden">
                                                    <input type="text" name="mbomID" class="form-control" value="<%= mbomData.mbomID %>" placeholder="Type Designation Here" id="" readonly="readonly" hidden="hidden">

                                                    <label for="" class="col-form-label"></label>
                                                    <button id="generateMBOMBtn" type="submit" class="btn-block btn-lg btn-outline-secondary waves-effect waves-light add-button" onclick="this.form.action='/generateMBOM'">Generate MBOM</button>
                                                <% } %>
                                            </form>
                                        </div>
                                    </div>
                                    <p class="text-muted m-b-30"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="card m-b-20">
                                <div class="card-body">
                                    <h4 class="mt-0 header-title">Circuit Breaker Summary</h4>
                                    <form id="breakerForm" class="breakerForm" action="/addBrk" method="POST">
                                        <div class="row">
                                            <% if(mbomData) { %>
                                                <div class="col-sm-12">
                                                    <input type="text" name="jobNum" class="form-control" value="<%= mbomData.jobNum %>" id="jobNum" hidden="hidden">
                                                    <input type="text" name="releaseNum" class="form-control" value="<%= mbomData.releaseNum %>" id="releaseNum" hidden="hidden">
                                                    <input type="text" name="mbomID" class="form-control" value="<%= mbomData.mbomID %>" id="mbomID" hidden="hidden">
                                                    <input type="text" name="jobName" class="form-control" value="<%= mbomData.jobName %>" id="jobName" hidden="hidden">
                                                    <input type="text" name="customer" class="form-control" value="<%= mbomData.customer %>" id="customer" hidden="hidden">
                                                    <input type="text" name="boardDesignation" class="form-control" value="<%= mbomData.boardDesignation %>" id="boardDesignation" hidden="hidden">
                                                    <input type="text" name="numSections" class="form-control" value="<%= mbomData.numSections %>" id="numSections" hidden="hidden">
                                                </div>
                                            <% } %>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label for="" class="col-form-label">Layout Name</label>
                                                    <input type="text" name="devLayout" class="form-control" value="<%=mbomData.boardDesignation%>" placeholder="Layout name here" id="" readonly="readonly">
                                                </div>
                                            </div>
                                            <div class="col-sm-6">
                                                <div class="form-group">
                                                    <label for="devDesLimit" class="col-form-label">Device Designation</label>
                                                    <input type="text" id="devDesLimit" maxlength="160" name="devDesignation" class="form-control counter" value="<%=brkData.devDesignation%>" data-toggle="tooltip" data-placement="top" title="To declare multiple breakers (i.e. CB-1A, CB-2A, ..., CB-6A), use the following convention: CB-(1-6)A" placeholder="Type Device Designation Here" autocomplete="off" required />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-sm-3">
                                                <div class="form-group">
                                                    <label for="brkPN" class="col-form-label">Breaker P/N</label>
                                                    <input type="text" name="brkPN" class="form-control" value="<%=brkData.brkPN%>" id="brkPN" placeholder="Type Breaker P/N Here" autocomplete="off" required />
                                                </div>
                                            </div>
                                            <div class="col-sm-3">
                                                <div class="form-group">
                                                    <label for="cradlePN" class="col-form-label">Cradle P/N</label>
                                                    <input type="text" name="cradlePN" class="form-control" value="<%=brkData.cradlePN%>" id="cradlePN" placeholder="Type Cradle P/N Here" autocomplete="off" required />
                                                </div>
                                            </div>
                                            <div class="col-sm-2">
                                                <div class="form-group">
                                                    <label for="devMfg" class="col-form-label">Manufacturer</label>
                                                    <input type="text" name="devMfg" class="form-control" value="<%=brkData.devMfg%>" id="devMfg" placeholder="Type Mfg. Here" autocomplete="off" required />
                                                </div>
                                            </div>
                                            <div class="col-sm-2">
                                                <div class="form-group">
                                                    <label for="devCatCode" class="col-form-label">Cat. Code</label>
                                                    <select class="form-control" name="catCode" id="devCatCode">
                                                        <option value="Select">Select</option>
                                                        <option value="00-CB" selected>00-CB</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-sm-2">
                                                <div class="form-group">
                                                    <label for="devClassCode" class="col-form-label">Class</label>
                                                    <select class="form-control" name="classCode" id="devClassCode" required>
                                                        <% if (brkData.class == 'MCCB') { %>
                                                            <option value="">Select</option>
                                                            <option value="MCCB" selected>MCCB</option>
                                                            <option value="ICCB">ICCB</option>
                                                        <% } else if (brkData.class == 'ICCB') { %>
                                                            <option value="">Select</option>
                                                            <option value="MCCB">MCCB</option>
                                                            <option value="ICCB" selected>ICCB</option>
                                                        <% } else { %>
                                                            <option value="">Select</option>
                                                            <option value="MCCB">MCCB</option>
                                                            <option value="ICCB">ICCB</option>
                                                        <% } %>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                            <div class="row justify-content-center">
                                                <div class="col-sm-2">
                                                    <% if(brkAccData.length != 0){ %>
                                                        <script> openBreakerAccessories() </script>
                                                        <div class="form-group" style="margin-top: 2.5rem; padding-left: 2.5rem;">
                                                            <input class="form-check-input" type="checkbox" name="addBreakerAccessories" id="addAccessories" checked="checked" onclick="openBreakerAccessories()">
                                                            <label class="form-check-label" for="addAccessories">Add Loose Accessories</label>
                                                        </div>
                                                    <% } else { %>
                                                        <div class="form-group" style="margin-top: 2.5rem; padding-left: 2.5rem;">
                                                            <input class="form-check-input" type="checkbox" name="addBreakerAccessories" id="addAccessories" onclick="openBreakerAccessories()">
                                                            <label class="form-check-label" for="addAccessories">Add Loose Accessories</label>
                                                        </div>
                                                    <% } %>
                                                </div>
                                            </div>

                                            <div class="col-sm-2">
                                                <div class="form-group">
                                                    <label for="" class="col-form-label"></label>
                                                    <input type="text" id="" name="unitOfIssue" class="form-control" value="EA" hidden="hidden"/>
                                                </div>
                                            </div>
                                    </form>
                                    <% if(brkAccData.length != 0){ %>
                                    <div class="row" id="breakerAccessoriesDiv" style="display: flex;">
                                    <% } else { %>
                                    <div class="row" id="breakerAccessoriesDiv" style="display: none;">
                                    <% } %>
                                        <div class="col-sm-12" style="margin-top: -1rem;">
                                            <hr>
                                        </div>
                                        <div class="col-sm-9">
                                            <h6>Loose Breaker Accessories</h6>
                                        </div>
                                        <div class="col-sm-3">
                                            <h6>Current Loose Accessories</h6>
                                        </div>
                                        <div class="col-sm-9">
                                            <div class="row" >
                                                <div class="col-sm-1">
                                                    <label for="accessoryQty" class="col-form-label">Qty</label>
                                                    <input type="number" min="1" id="accessoryQty" name="accessoryQty" class="form-control" value="" placeholder="#" autocomplete="off" required/>
                                                </div>
                                                <div class="col-sm-2">
                                                    <label for="accessoryType" class="col-form-label">Accessory Type</label>
                                                    <input type="text" id="accessoryType" name="accessoryType" class="form-control" value="" placeholder="Type Accessory Type" autocomplete="off" required/>
                                                </div>
                                                <div class="col-sm-4">
                                                    <label for="accessoryDescLimit" class="col-form-label">Description</label>
                                                    <input type="text" id="accessoryDescLimit" maxlength="160" name="accessoryDesc" class="form-control" value="" placeholder="Type Accessory Description" autocomplete="off" required/>
                                                </div>
                                                <div class="col-sm-3">
                                                    <label for="accessoryPN" class="col-form-label">P/N</label>
                                                    <input type="text" id="accessoryPN" name="accessoryPN" class="form-control" value="" placeholder="Type P/N Here" autocomplete="off" required/>
                                                </div>
                                                <div class="col-sm-2" style="margin-top: 2.2rem;">
                                                    <button id="addAccessoryBtn" type="submit" class="btn btn-md btn-outline-info waves-effect waves-light" onclick="addBrkAccessory()">Add Accessory</button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-sm-3">
                                            <ul class="list-group">
                                                <% for(let i = 0; i < brkAccData.length; i++){ %>
                                                <li class="list-group-item d-flex justify-content-between align-items-center" style="padding: 4% 4% 0 4%;">
                                                    <p style="width: 50%;">
                                                        <span class="badge badge-info"><%=brkAccData[i].qty%></span>  <%=brkAccData[i].desc%>
                                                    </p>
                                                    <p>
                                                        <input id="editButton" type="submit" value="Edit" class="btn btn-md btn-outline-warning waves-effect waves-light" data-toggle="modal" data-target="#editAccModal_<%=i%>"/>
                                                        <button id="delAcc_<%= i %>" type="button" value="Delete" class="btn btn-md btn-outline-danger waves-effect waves-light" onclick="deleteBrkAcc(this)" data-acc-id="<%= i %>" data-dev="<%= brkAccData[i].idDev || '' %>">Delete</button>
                                                    </p>
                                                </li>

                                                <!-- EDIT BRK ACC MODAL -->
                                                <div class="modal fade" id="editAccModal_<%=i%>" tabindex="-1" role="dialog" aria-labelledby="editAccModalTitle" aria-hidden="true">
                                                    <div class="modal-dialog modal-dialog-centered" role="document">
                                                        <div class="modal-content">
                                                            <div class="modal-header">
                                                                <h5 class="modal-title" id="exampleModalLongTitle" style="font-size: large">Edit Breaker Accessory</h5>
                                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                                    <span aria-hidden="true">&times;</span>
                                                                </button>
                                                            </div>
                                                            <p class="mb-2"></p>
                                                            <div class="col-sm-12 justify-content-center">
                                                                <p class="mb-0">
                                                                    Edit any of the following for the layout shown above, and click "Save Changes" afterwards
                                                                </p>
                                                            </div>
                                                            <div class="modal-body">
                                                                <div class="form-group">
                                                                    <div class="row">
                                                                        <div class="col-sm-3">
                                                                            <label for="editAccQty" class="col-form-label">Qty</label>
                                                                            <input type="number" min="1" id="editAccQty" name="editAccQty" class="form-control" value="<%=brkAccData[i].qty%>" placeholder="#" autocomplete="off" required/>
                                                                        </div>
                                                                        <div class="col-sm-9">
                                                                            <label for="editAccType" class="col-form-label">Accessory Type</label>
                                                                            <input type="text" id="editAccType" name="editAccType" class="form-control" value="<%=brkAccData[i].type%>" placeholder="Type Accessory Type" autocomplete="off" required/>
                                                                        </div>
                                                                    </div>
                                                                    <div class="row">
                                                                        <div class="col-sm-12">
                                                                            <label for="editAccDescLimit" class="col-form-label">Description</label>
                                                                            <input type="text" id="editAccDescLimit" maxlength="160" name="editAccDescLimit" class="form-control" value="<%=brkAccData[i].desc%>" placeholder="Type Accessory Description" autocomplete="off" required/>
                                                                        </div>
                                                                    </div>
                                                                    <div class="row">
                                                                        <div class="col-sm-12">
                                                                            <label for="editAccPN" class="col-form-label">P/N</label>
                                                                            <input type="text" id="editAccPN" name="editAccPN" class="form-control" value="<%=brkAccData[i].pn%>" placeholder="Type P/N Here" autocomplete="off" required/>
                                                                        </div>
                                                                    </div>
                                                                    <div class="modal-footer justify-content-center" style="border-top: none;">
                                                                        <input id="editBrkAccnBtn" type="submit" value="Save Changes" class="btn-block btn-lg btn-success col-sm-5 edit-brk-acc-btn" style="border: 0" data-index="<%= i %>" />
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- END EDIT BRK ACC MODAL -->
                                                <% } %>
                                            </ul>
                                        </div>
                                    </div>
                                    <!-- Add button moved above the horizontal rule so it's closer to the Loose Accessories section -->
                                    <div class="row justify-content-center mb-3" style="margin-top: .5rem;">
                                        <div class="col-2 text-center">
                                            <input id="uploadBtn" type="submit" value="Add" class="btn-block btn-lg btn-outline-secondary waves-effect waves-light" form="breakerForm"/>
                                        </div>
                                    </div>
                                    <hr>
                                    <p class="text-muted m-b-15"></p>
                                        <% if(mbomBrkData.length != 0){ %>
                                        <div class="row mb-2">
                                            <div class="col-sm-4">
                                                <input type="text" id="brkFilter" class="form-control" placeholder="Filter breakers (any column)..." />
                                            </div>
                                            <div class="col-sm-2">
                                                <select id="brkGroupSelect" class="form-control">
                                                    <option value="none">No Grouping</option>
                                                    <option value="device">Group: Device Designation</option>
                                                    <option value="brkPN">Group: Breaker P/N</option>
                                                    <option value="cradlePN">Group: Cradle P/N</option>
                                                    <option value="section">Group: Section #</option>
                                                </select>
                                            </div>
                                            <div class="col-sm-2">
                                                <button id="brkClearFilter" type="button" class="btn btn-outline-danger" style="height:38px; padding: .375rem .75rem;">Clear Filter</button>
                                            </div>
                                        </div>
                                        <p class="text-muted m-b-30"></p>
                                        <table id="breakersTable" class="table table-condensed table-bordered dt-responsive nowrap groupable-table" data-group-col="none">
                                            <thead>
                                            <tr>
                                                <th style="display: none;">ID</th>
                                                <th style="display:none;">MBOM ID</th>
                                                <th style="width:12%;">Device Designation</th>
                                                <th style="width:10%;">Cat. Code</th>
                                                <th style="width:20%;">Breaker P/N</th>
                                                <th style="width:20%;">Cradle P/N</th>
                                                <th style="width:15%;">Section #</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <% if (mbomBrkData) { %>
                                                <form id="brkForm" class="brkForm" action="" method="POST">
                                                    <% if(mbomData) { %>
                                                        <div class="col-sm-12">
                                                            <input type="text" name="jobNum" class="form-control" value="<%= mbomData.jobNum %>" id="jobNum" hidden="hidden">
                                                            <input type="text" name="releaseNum" class="form-control" value="<%= mbomData.releaseNum %>" id="releaseNum" hidden="hidden">
                                                            <input type="text" name="mbomID" class="form-control" value="<%= mbomData.mbomID %>" id="mbomID" hidden="hidden">
                                                            <input type="text" name="jobName" class="form-control" value="<%= mbomData.jobName %>" id="jobName" hidden="hidden">
                                                            <input type="text" name="customer" class="form-control" value="<%= mbomData.customer %>" id="customer" hidden="hidden">
                                                            <input type="text" name="boardDesignation" class="form-control" value="<%= mbomData.boardDesignation %>" id="boardDesignation" hidden="hidden">
                                                            <input type="text" name="numSections" class="form-control" value="<%= mbomData.numSections %>" id="numSections" hidden="hidden">
                                                            <input type="text" name="noSectionMBOM" class="form-control" value="<%= mbomData.noSectionMBOM%>" id="noSectionMBOM" hidden="hidden">
                                                        </div>
                                                    <% } %>
                                                    <%
                                                        let idDevs = new Set();
                                                        for(let el of mbomBrkAcc){
                                                            for(let row of mbomBrkData){
                                                                if(el.idDev == row.idDev)
                                                                    idDevs.add(el.idDev.toString());
                                                            }
                                                        }
                                                    %>
                                                    <% for (let i = 0; i < mbomBrkData.length; i++) { %>
                                                        <% let currentBrk = mbomBrkData[i].idDev;%>
                                                        <% currentBrk = currentBrk.toString(); %>
                                                        <% let secLabel = 'Unassigned'; %>
                                                        <% if (mbomBrkData[i].secID != null) { %>
                                                            <% for (let s = 0; s < (mbomSecData || []).length; s++) { %>
                                                                <% if (mbomSecData[s].secID == mbomBrkData[i].secID) { %>
                                                                        <% 
                                                                            const sn = parseInt(mbomSecData[s].sectionNum, 10);
                                                                            if (!isNaN(sn) && sn < 10) {
                                                                                secLabel = 'Section 10' + sn;
                                                                            } else {
                                                                                secLabel = 'Section 1' + (isNaN(sn) ? mbomSecData[s].sectionNum : sn);
                                                                            }
                                                                        %>
                                                                    <% break; %>
                                                                <% } %>
                                                            <% } %>
                                                        <% } %>
                                                        <tr data-toggle="collapse" data-target="#breaker<%=currentBrk%>" class="accordion-toggle">
                                                            <td style="display: none;"><%= mbomBrkData[i].idDev %></td>
                                                            <td style="display: none;"><%= mbomBrkData[i].mbomID %></td>
                                                            <td>
                                                                <%= mbomBrkData[i].devDesignation%>
                                                                <% if(idDevs.has(currentBrk)){ %>
                                                                    <i class="fas fa-angle-down rotate-icon"></i>
                                                                <% } %>
                                                            </td>
                                                            <td><%= mbomBrkData[i].catCode %></td>
                                                            <td><%= mbomBrkData[i].brkPN %></td>
                                                            <td><%= mbomBrkData[i].cradlePN %></td>
                                                            <td><%= secLabel %></td>
                                                            <td>
                                                                <input id="copyButton" type="submit" value="Copy" class="btn btn-md btn-outline-secondary waves-effect waves-light" onclick="this.form.action='../copyBreaker/?idDev=<%= mbomBrkData[i].idDev%>'"/>
                                                                <input id="editBrkButton" type="submit" value="Edit" class="btn btn-md btn-outline-warning waves-effect waves-light" onclick="this.form.action='../editBreaker/?idDev=<%= mbomBrkData[i].idDev%>'"/>
                                                                <input id="deleteButton" type="submit" value="Delete" class="btn btn-md btn-outline-danger waves-effect waves-light" onclick="this.form.action='../deleteBreaker/?idDev=<%= mbomBrkData[i].idDev%>'"/>
                                                            </td>
                                                        </tr>
                                                        <% if(idDevs.has(currentBrk)){ %>
                                                        <tr>
                                                            <td id="brkAccTD" colspan="7" class="hiddenRow">
                                                                <div class="accordion-body collapse in no-transition" id="breaker<%=currentBrk%>">
                                                                    <h6>Accessories</h6>
                                                                    <table id="brkAccTable" align="center">
                                                                        <thead>
                                                                        <tr>
                                                                            <th style="width: 10%">Qty</th>
                                                                            <th style="width: 20%">Type</th>
                                                                            <th style="width: 20%">Mfg.</th>
                                                                            <th style="width: 25%">Description</th>
                                                                            <th style="width: 25%">P/N</th>
                                                                        </tr>
                                                                        </thead>
                                                                        <tbody>
                                                                        <% for(let row of mbomBrkAcc){ %>
                                                                        <%if(row.idDev == mbomBrkData[i].idDev){ %>
                                                                        <tr>
                                                                            <td><%=row.brkAccQty%></td>
                                                                            <td><%=row.brkAccType%></td>
                                                                            <td><%=row.brkAccMfg%></td>
                                                                            <td><%=row.brkAccDesc%></td>
                                                                            <td><%=row.brkAccPN%></td>
                                                                        </tr>
                                                                        <% } %>
                                                                        <% } %>
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <% } %>
                                                    <% } %>
                                                </form>
                                            <% } %>
                                            </tbody>
                                        </table>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="card m-b-20">
                                <div class="card-body">
                                    <h4 class="mt-0 header-title">Item Summary</h4>
                                    <div class="card-body">
                                        <h6>Commonly Used</h6>
                                        <form id="commonItemsForm" class="commonItemsForm" action="" method="POST">
                                            <div class="form-group">
                                                <div class="row">
                                                    <% if(mbomData) { %>
                                                        <div class="col-sm-12">
                                                            <input type="text" name="jobNum" class="form-control" value="<%= mbomData.jobNum %>" id="jobNum" hidden="hidden">
                                                            <input type="text" name="releaseNum" class="form-control" value="<%= mbomData.releaseNum %>" id="releaseNum" hidden="hidden">
                                                            <input type="text" name="mbomID" class="form-control" value="<%= mbomData.mbomID %>" id="mbomID" hidden="hidden">
                                                            <input type="text" name="jobName" class="form-control" value="<%= mbomData.jobName %>" id="jobName" hidden="hidden">
                                                            <input type="text" name="customer" class="form-control" value="<%= mbomData.customer %>" id="customer" hidden="hidden">
                                                            <input type="text" name="boardDesignation" class="form-control" value="<%= mbomData.boardDesignation %>" id="boardDesignation" hidden="hidden">
                                                            <input type="text" name="numSections" class="form-control" value="<%= mbomData.numSections %>" id="numSections" hidden="hidden">
                                                        </div>
                                                    <% } %>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-1">
                                                        <label for="itemQty" class="col-form-label">Qty</label>
                                                        <input type="number" min="1" id="itemQty" name="itemQty" class="form-control" value="" placeholder="#" autocomplete="off" required/>
                                                    </div>
                                                    <div class="col-sm-2">
                                                        <label for="itemSelect" class="col-form-label">Item Type</label>
                                                        <select class="form-control select2" id="itemSelect" name="itemType" required>
                                                            <option value="">Select</option>
                                                            <% let itemTypes = new Set();%>
                                                            <% for(let el of comItemData){
                                                                itemTypes.add(el.itemType);
                                                            } %>
                                                            <% for(let el of itemTypes){ %>
                                                                <option value="<%= el%>"><%=el%></option>
                                                            <% } %>
                                                        </select>
                                                    </div>
                                                    <div class="col-sm-2">
                                                        <label for="mfgSelect" class="col-form-label">Item Mfg.</label>
                                                        <select class="form-control select2" id="mfgSelect" name="itemMfg">
                                                            <option data-parent="Select" value="Select">Select</option>
                                                            <% let itemMfg = new Set();%>
                                                            <% for(let el of comItemData){
                                                                itemMfg.add(el.itemType + "|" + el.itemMfg);
                                                            } %>
                                                            <% for(let el of itemMfg){ %>
                                                            <option data-parent="<%=el.split('|')[0]%>" value="<%= el%>"><%= el.split('|')[1]%></option>
                                                            <% } %>
                                                        </select>
                                                    </div>
                                                    <div class="col-sm-3">
                                                        <label for="descSelect" class="col-form-label">Description</label>
                                                        <select class="form-control" id="descSelect" name="itemDesc">
                                                            <option data-parent="Select" value="Select">Select</option>
                                                            <% for(let el of comItemData){ %>
                                                            <option data-parent="<%=el.itemType%>|<%=el.itemMfg%>" value="<%=el.itemType%>|<%=el.itemMfg%>|<%= el.itemDesc%>"><%=el.itemDesc%></option>
                                                            <% } %>
                                                        </select>
                                                    </div>
                                                    <div class="col-sm-2">
                                                        <label for="pnSelect" class="col-form-label">P/N</label>
                                                        <select class="form-control" id="pnSelect" name="itemPN">
                                                            <option data-parent="Select" value="Select">Select</option>
                                                            <% for(let el of comItemData){ %>
                                                            <option data-parent="<%=el.itemType%>|<%=el.itemMfg%>|<%= el.itemDesc%>" value="<%=el.itemType%>|<%=el.itemMfg%>|<%= el.itemDesc%>|<%=el.itemPN%>"><%=el.itemPN%></option>
                                                            <% } %>
                                                        </select>
                                                    </div>
                                                    <div class="col-sm-2" style="margin-top: 2rem; padding-left: 3.5rem;">
                                                        <input class="form-check-input" type="checkbox" name="shipLoose" id="shipLoose" value="true" style="margin-top: .7rem;"/>
                                                        <label for="shipLoose" class="col-form-label">Ship Loose Item?</label>
                                                    </div>
                                                </div>
                                                <div class="row justify-content-center">
                                                    <div class="col-sm-2">
                                                        <label for="uploadBtn"></label>
                                                        <input id="uploadBtn" type="submit" value="Add" onclick="this.form.action='/addComItem'" class="btn-block btn-lg btn-outline-secondary waves-effect waves-light" />
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                        <h6>User Defined</h6>
                                        <form id="userDefinedForm" class="userDefinedForm" action="" method="POST">
                                            <div class="form-group">
                                                <div class="row">
                                                    <% if(mbomData) { %>
                                                        <div class="col-sm-12">
                                                            <input type="text" name="jobNum" class="form-control" value="<%= mbomData.jobNum %>" id="jobNum" hidden="hidden">
                                                            <input type="text" name="releaseNum" class="form-control" value="<%= mbomData.releaseNum %>" id="releaseNum" hidden="hidden">
                                                            <input type="text" name="mbomID" class="form-control" value="<%= mbomData.mbomID %>" id="mbomID" hidden="hidden">
                                                            <input type="text" name="jobName" class="form-control" value="<%= mbomData.jobName %>" id="jobName" hidden="hidden">
                                                            <input type="text" name="customer" class="form-control" value="<%= mbomData.customer %>" id="customer" hidden="hidden">
                                                            <input type="text" name="boardDesignation" class="form-control" value="<%= mbomData.boardDesignation %>" id="boardDesignation" hidden="hidden">
                                                            <input type="text" name="numSections" class="form-control" value="<%= mbomData.numSections %>" id="numSections" hidden="hidden">
                                                        </div>
                                                    <% } %>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-1">
                                                        <label for="" class="col-form-label">Qty</label>
                                                        <input type="number" min="1" id="" name="itemQty" class="form-control" value="" placeholder="#" autocomplete="off" required/>
                                                    </div>
                                                    <div class="col-sm-2">
                                                        <label for="itemSelect2" class="col-form-label">Item Type</label>
                                                        <select class="form-control select2" id="itemSelect2" name="itemSelect2" required>
                                                            <option value="">Select</option>
                                                            <% let userItemTypes = new Set();%>
                                                            <% for(let el of comItemData){
                                                                userItemTypes.add(el.itemType);
                                                            } %>
                                                            <% for(let el of userItemTypes){ %>
                                                                <option value="<%= el%>"><%=el%></option>
                                                            <% } %>
                                                            <option>OTHER</option>
                                                        </select>
                                                        <label for="otherItemType" class="col-form-label"></label>
                                                        <input type="text" name="otherItemType" class="form-control" id="otherItemType" placeholder="Type Item Type" style="display:none;" autocomplete="off"/>
                                                    </div>
                                                    <div class="col-sm-2">
                                                        <label for="mfgSelect2" class="col-form-label">Item Mfg.</label>
                                                        <select class="form-control select2" id="mfgSelect2" name="mfgSelect2">
                                                            <option value="">Select</option>
                                                            <% let userItemMfg = new Set();%>
                                                            <% let other = new Set()%>
                                                            <% for(let el of comItemData){
                                                                userItemMfg.add(el.itemType + "|" + el.itemMfg);
                                                            } %>
                                                            <% for(let el of comItemData){
                                                                other.add(el.itemType + "|" + "OTHER");
                                                            } %>
                                                            <% for(let el of userItemMfg){ %>
                                                            <option data-parent="<%=el.split('|')[0]%>" value="<%= el%>"><%= el.split('|')[1]%></option>
                                                            <% } %>
                                                            <% for(let el of other){ %>
                                                            <option data-parent="<%=el.split('|')[0]%>"><%=el.split('|')[1]%></option>
                                                            <% } %>
                                                        </select>
                                                        <label for="mfgList" class="col-form-label"></label>
                                                        <select class="form-control select2" id="mfgList" name="mfgList">
                                                            <option value="">Select</option>
                                                            <% let userItemMfg2 = new Set();%>
                                                            <% for(let el of comItemData){
                                                                userItemMfg2.add(el.itemMfg);
                                                            } %>
                                                            <% for(let el of userItemMfg2){ %>
                                                                <option value="<%= el%>"><%= el%></option>
                                                            <% } %>
                                                            <option>OTHER</option>
                                                        </select>
                                                        <label for="otherMfgType" class="col-form-label"></label>
                                                        <input type="text" name="otherMfgType" class="form-control" id="otherMfgType" placeholder="Type Item Mfg" style="display:none;" autocomplete="off"/>
                                                    </div>
                                                    <div class="col-sm-7">
                                                        <label for="itemDescLimit" class="col-form-label">Description</label>
                                                        <input type="text" id="itemDescLimit" maxlength="160" name="itemDesc" class="form-control" value="" placeholder="Type Item Description" autocomplete="off" required/>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-sm-4">
                                                        <label for="" class="col-form-label">P/N</label>
                                                        <input type="text" name="itemPN" id="" class="form-control" value="" placeholder="Type P/N Here" autocomplete="off" required/>
                                                    </div>
                                                    <div class="col-sm-2">
                                                        <label for="" class="col-form-label">Unit of Issue</label>
                                                        <select class="form-control" name="unitOfIssue" id="">
                                                            <option value="Select">Select</option>
                                                            <option value="EA">EA</option>
                                                            <option value="FT">FT</option>
                                                            <option value="LBS">LBS</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-sm-2">
                                                        <label for="" class="col-form-label">Cat. Code</label>
                                                        <select class="form-control" name="catCode"  id="">
                                                            <option value="Select">Select</option>
                                                            <% for (let i = 0; i < catCodeData.length; i++) { %>
                                                                <option value="<%= catCodeData[i]%>"><%= catCodeData[i]%></option>
                                                            <% } %>
                                                        </select>
                                                    </div>
                                                    <div class="col-sm-2">
                                                        <label for="" class="col-form-label">Class</label>
                                                        <select class="form-control" name="classCode" id="">
                                                            <option value="Select">Select</option>
                                                            <% for (let i = 0; i < classCodeData.length; i++) { %>
                                                                <option value="<%= classCodeData[i]%>"><%=classCodeData[i]%></option>
                                                            <% } %>
                                                        </select>
                                                    </div>
                                                    <div class="col-sm-2" style="margin-top: 2rem; padding-left: 3.5rem;">
                                                        <input class="form-check-input" type="checkbox" name="userShipLoose" id="userShipLoose" value="true" style="margin-top: .7rem;"/>
                                                        <label for="userShipLoose" class="col-form-label">Ship Loose Item?</label>
                                                    </div>
                                                </div>
                                                <div class="row justify-content-center">
                                                    <div class="col-sm-2">
                                                        <label for="uploadBtn"></label>
                                                        <input id="uploadBtn" type="submit" value="Add" class="btn-block btn-lg btn-outline-secondary waves-effect waves-light" onclick="this.form.action='/createUserItem'"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <% if(mbomItemData.length != 0){ %>
                                        <p class="text-muted m-b-30"></p>
                                        <div class="row mb-2">
                                            <div class="col-sm-4">
                                                <input type="text" id="itemFilter" class="form-control" placeholder="Filter items (any column)..." />
                                            </div>
                                            <div class="col-sm-2">
                                                <button id="itemClearFilter" type="button" class="btn btn-sm btn-outline-secondary">Clear Filter</button>
                                            </div>
                                        </div>
                                        <table id="itemsTable" class="table table-bordered dt-responsive nowrap groupable-table" data-group-col="2" style="border-collapse: collapse; border-spacing: 0; width: 100%;">
                                            <thead>
                                            <tr>
                                                <th style="display:none;">Sum Item ID</th>
                                                <th style="display:none;">Com Item ID</th>
                                                <th style="display:none;">User Item ID</th>
                                                <th style="width:5%;">Qty</th>
                                                <th style="width:10%;">Item Type</th>
                                                <th style="width:10%;">Item Mfg</th>
                                                <th style="width:15%;">Item Description</th>
                                                <th style="width:10%;">Item P/N</th>
                                                <th style="width:7%;">Section</th>
                                                <th style="width:6%;">Ship Loose?</th>
                                                <th style="width:15%;"></th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                                <% if (mbomItemData) { %>
                                                <% for (let i =0; i < mbomItemData.length; i++) { %>
                                                    <form id="itemForm" class="itemForm" action="" method="POST">
                                                        <% 
                                                            let secLabel = 'Unassigned';
                                                            if (mbomItemData[i] && mbomItemData[i].secID != null) {
                                                                for (let s = 0; s < (mbomSecData || []).length; s++) {
                                                                    if (mbomSecData[s].secID == mbomItemData[i].secID) {
                                                                        const sn = parseInt(mbomSecData[s].sectionNum, 10);
                                                                        if (!isNaN(sn) && sn < 10) {
                                                                            secLabel = 'Section 10' + sn;
                                                                        } else {
                                                                            secLabel = 'Section 1' + (isNaN(sn) ? mbomSecData[s].sectionNum : sn);
                                                                        }
                                                                        break;
                                                                    }
                                                                }
                                                            }
                                                        %>
                                                        <div class="row">
                                                            <% if(mbomData) { %>
                                                                <input type="text" name="jobNum" class="form-control" value="<%= mbomData.jobNum %>" id="jobNum" hidden="hidden">
                                                                <input type="text" name="releaseNum" class="form-control" value="<%= mbomData.releaseNum %>" id="releaseNum" hidden="hidden">
                                                                <input type="text" name="mbomID" class="form-control" value="<%= mbomData.mbomID %>" id="mbomID" hidden="hidden">
                                                                <input type="text" name="jobName" class="form-control" value="<%= mbomData.jobName %>" id="jobName" hidden="hidden">
                                                                <input type="text" name="customer" class="form-control" value="<%= mbomData.customer %>" id="customer" hidden="hidden">
                                                                <input type="text" name="boardDesignation" class="form-control" value="<%= mbomData.boardDesignation %>" id="boardDesignation" hidden="hidden">
                                                                <input type="text" name="numSections" class="form-control" value="<%= mbomData.numSections %>" id="numSections" hidden="hidden">
                                                            <% } %>
                                                        </div>
                                                        <% if (mbomItemData[i].userItemID == null) { %>
                                                        <%for(var j = 0; j < comItemData.length; j++){ %>
                                                        <%if(mbomItemData[i].comItemID == comItemData[j].comItemID){ %>
                                                            <tr>
                                                                <td style="display: none;"><%= mbomItemData[i].itemSumID %></td>
                                                                <td style="display: none;"><%= mbomItemData[i].comItemID %></td>
                                                                <td style="display: none;"><%= mbomItemData[i].userItemID %></td>
                                                                <td><%= mbomItemData[i].itemQty %></td>
                                                                <td><%= comItemData[j].itemType %></td>
                                                                <td><%= comItemData[j].itemMfg %></td>
                                                                <td><%= comItemData[j].itemDesc %></td>
                                                                <td><%= comItemData[j].itemPN %></td>
                                                                <td><%= secLabel %></td>
                                                                <td><%= String(mbomItemData[i].shipLoose).toUpperCase() === 'Y' ? 'Yes' : 'No' %></td>
                                                                <td>
                                                                    <input id="copyButton" type="submit" value="Copy" class="btn btn-md btn-outline-secondary waves-effect waves-light" onclick="this.form.action='../copyItem/?itemSumID=<%= mbomItemData[i].itemSumID%>'"/>
                                                                    <% if(mbomItemData[i].userItemID != null){%>
                                                                        <input id="editButton" type="submit" value="Edit" class="btn btn-md btn-outline-warning waves-effect waves-light" onclick="this.form.action='../editUserItem/?itemSumID=<%= mbomItemData[i].itemSumID%>&userItemID=<%=mbomItemData[i].userItemID%>'"/>
                                                                    <% }else{ %>
                                                                        <input id="editButton" type="submit" value="Edit" class="btn btn-md btn-outline-warning waves-effect waves-light" onclick="this.form.action='../editComItem/?itemSumID=<%= mbomItemData[i].itemSumID%>&comItemID=<%=mbomItemData[i].comItemID%>'"/>
                                                                    <% } %>
                                                                    <input id="deleteButton" type="submit" value="Delete" class="btn btn-md btn-outline-danger waves-effect waves-light" onclick="this.form.action='../deleteItem/?itemSumID=<%= mbomItemData[i].itemSumID %>'"/>
                                                                </td>
                                                            </tr>
                                                        <% } %>
                                                        <% } %>
                                                        <% } else { %>
                                                        <%for(let j = 0; j < userItemData.length; j++){ %>
                                                        <%if(mbomItemData[i].userItemID == userItemData[j].userItemID){ %>
                                                            <tr>
                                                                <td style="display: none;"><%= mbomItemData[i].itemSumID %></td>
                                                                <td style="display: none;"><%= mbomItemData[i].comItemID %></td>
                                                                <td style="display: none;"><%= mbomItemData[i].userItemID %></td>
                                                                <td><%= mbomItemData[i].itemQty %></td>
                                                                <td><%= userItemData[j].itemType %></td>
                                                                <td><%= userItemData[j].itemMfg %></td>
                                                                <td><%= userItemData[j].itemDesc %></td>
                                                                <td><%= userItemData[j].itemPN %></td>
                                                                <td><%= secLabel %></td>
                                                                <td><%= String(mbomItemData[i].shipLoose).toUpperCase() === 'Y' ? 'Yes' : 'No' %></td>
                                                                <td>
                                                                    <input id="copyButton" type="submit" value="Copy" class="btn btn-md btn-outline-secondary waves-effect waves-light" onclick="this.form.action='../copyItem/?itemSumID=<%= mbomItemData[i].itemSumID%>'"/>
                                                                    <% if(mbomItemData[i].userItemID != null){%>
                                                                        <input id="editButton" type="submit" value="Edit" class="btn btn-md btn-outline-warning waves-effect waves-light" onclick="this.form.action='../editUserItem/?itemSumID=<%= mbomItemData[i].itemSumID%>&userItemID=<%=mbomItemData[i].userItemID%>'" />
                                                                    <% }else{ %>
                                                                        <input id="editButton" type="submit" value="Edit" class="btn btn-md btn-outline-warning waves-effect waves-light" onclick="this.form.action='../editComItem/?itemSumID=<%= mbomItemData[i].itemSumID%>&comItemID=<%=mbomItemData[i].comItemID%>'"/>
                                                                    <% } %>
                                                                    <input id="deleteButton" type="submit" value="Delete" class="btn btn-md btn-outline-danger waves-effect waves-light" onclick="this.form.action='../deleteItem/?itemSumID=<%= mbomItemData[i].itemSumID %>'"/>
                                                                </td>
                                                            </tr>
                                                        <% } %>
                                                        <% } %>
                                                        <% } %>
                                                    </form>
                                                <% } %>
                                            <% } %>
                                            </tbody>
                                        </table>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>
                    </div>
                </div>
            </div>
        </div> <!-- container-fluid -->
    </div> <!-- content -->
</div> <!-- content-page -->
    <%- include('../partials/footer') %>
</div> <!-- wrapper -->


<!-- MBOM table grouping & sorting (client-side) -->
<script>
document.addEventListener('DOMContentLoaded', function(){
    function escapeText(t){ return (t||'').toString().trim().toLowerCase(); }
    function getColText(row, colIndex){
        const cells = row.querySelectorAll('td,th');
        if (cells.length>colIndex) return escapeText(cells[colIndex].textContent);
        return escapeText(row.textContent);
    }

    function groupTable(tableId){
        const table = document.getElementById(tableId);
        if(!table) return;
        const tbody = table.tBodies[0];
        if(!tbody) return;
        const groupColAttr = table.getAttribute('data-group-col');
        // if no group column specified or explicitly set to 'none', don't apply grouping
        if (!groupColAttr || groupColAttr === 'none') return;
        const groupCol = parseInt(groupColAttr,10);
        const allRows = Array.from(tbody.querySelectorAll('tr'));
        // remove existing group headers
        allRows.filter(r=>r.classList && r.classList.contains('group-header')).forEach(r=>r.remove());
        // only consider visible main rows (filtering has precedence)
        const mainRows = allRows.filter(r=> {
            const td = r.querySelector('td');
            return td && !td.hasAttribute('colspan') && r.style.display !== 'none';
        });
        const colCount = table.querySelectorAll('thead th').length || (mainRows[0] ? mainRows[0].cells.length : 1);
        // if there are no visible rows after filtering, do not remove rows from the DOM
        // leave tbody as-is (rows may be hidden) so clearing the filter can restore visibility
        if(mainRows.length === 0) return;
        let seen = new Map();
        mainRows.forEach((row)=> {
            const key = getColText(row, groupCol) || 'Unassigned';
            if(!seen.has(key)) seen.set(key, []);
            seen.get(key).push(row);
        });
        // sort group keys ascending (numeric when possible, otherwise lexicographic)
        const keys = Array.from(seen.keys());
        keys.sort((a,b)=>{
            const an = parseFloat(a);
            const bn = parseFloat(b);
            if(!isNaN(an) && !isNaN(bn)) return an - bn;
            if(a < b) return -1;
            if(a > b) return 1;
            return 0;
        });
        // rebuild tbody so rows are grouped (groups appear contiguously)
        const oldRows = Array.from(tbody.querySelectorAll('tr'));
        // build map of original-index -> {row, detail}
        const entriesByOrig = new Map();
        for(let i=0;i<oldRows.length;i++){
            const r = oldRows[i];
            const firstTd = r.querySelector('td');
            if(!firstTd) continue;
            if(firstTd.hasAttribute('colspan')){
                // detail row: attach to previous main entry if exists (use orig index)
                const prev = oldRows[i-1];
                const orig = prev && prev.getAttribute ? prev.getAttribute('data-orig-index') : null;
                if(orig !== null && entriesByOrig.has(orig)){
                    entriesByOrig.get(orig).detail = r;
                }
                continue;
            }
            const orig = r.getAttribute('data-orig-index') || null;
            const obj = {row: r, detail: null, orig: orig !== null ? parseInt(orig,10) : Number.MAX_SAFE_INTEGER};
            entriesByOrig.set(String(obj.orig), obj);
        }

        // track which origs we've appended
        const appended = new Set();
        const frag = document.createDocumentFragment();
        for(const key of keys){
            const rowsForKey = seen.get(key) || [];
            if(rowsForKey.length === 0) continue;
            // create header
            const header = document.createElement('tr');
            header.className = 'group-header';
            const hd = document.createElement('td');
            hd.colSpan = colCount + 1;
            hd.style.cursor = 'pointer';
            hd.style.background = '#f5f5f5';
            hd.style.fontWeight = '600';
            hd.style.padding = '6px 12px';
            const label = document.createElement('span');
            label.textContent = (key ? key.toUpperCase() : 'UNASSIGNED') + ' (' + rowsForKey.length + ')';
            const icon = document.createElement('span');
            icon.style.float = 'right';
            icon.textContent = '\u25BC';
            hd.appendChild(label);
            hd.appendChild(icon);
            header.appendChild(hd);
            frag.appendChild(header);
            // append each visible row in this group (use orig map to include their detail rows)
            rowsForKey.forEach(r => {
                const orig = r.getAttribute && r.getAttribute('data-orig-index');
                if(orig !== null && entriesByOrig.has(orig)){
                    const ent = entriesByOrig.get(orig);
                    frag.appendChild(ent.row);
                    if(ent.detail) frag.appendChild(ent.detail);
                    appended.add(orig);
                } else {
                    // fallback: append row and its possible next detail
                    frag.appendChild(r);
                    const next = r.nextElementSibling;
                    if(next && next.querySelector('td') && next.querySelector('td').hasAttribute('colspan')) frag.appendChild(next);
                }
            });
            header.addEventListener('click', function(){
                const isCollapsed = header.classList.toggle('collapsed');
                icon.textContent = isCollapsed ? '\u25B6' : '\u25BC';
                rowsForKey.forEach(r => {
                    r.style.display = isCollapsed ? 'none' : '';
                    const next = r.nextElementSibling;
                    if(next && next.querySelector('td') && next.querySelector('td').hasAttribute('colspan')){
                        next.style.display = isCollapsed ? 'none' : '';
                    }
                });
            });
        }

        // append any rows not yet appended (including hidden ones) in original order
        const remaining = Array.from(entriesByOrig.values()).sort((a,b)=>a.orig - b.orig);
        remaining.forEach(ent => {
            const key = String(ent.orig);
            if(appended.has(key)) return;
            frag.appendChild(ent.row);
            if(ent.detail) frag.appendChild(ent.detail);
        });

        // replace tbody contents with the new arrangement (includes hidden rows)
        tbody.innerHTML = '';
        tbody.appendChild(frag);
    }

    function setupFilter(inputId, tableId){
        const input = document.getElementById(inputId);
        const table = document.getElementById(tableId);
        if (window.__DEBUG) console.log('setupFilter init', inputId, tableId, !!input, !!table);
        if(!input || !table) return;
        const tbody = table.tBodies[0];
        input.addEventListener('input', function(){
            try{
                const q = input.value.trim().toLowerCase();
                const rows = Array.from(tbody.querySelectorAll('tr'));
                if (window.__DEBUG) console.log('MBOM FILTER', inputId, q, rows.length);
                rows.forEach(r => {
                    if(r.classList && r.classList.contains('group-header')) return;
                    const tds = Array.from(r.querySelectorAll('td'));
                    if(tds.length === 0) return;
                    const text = tds.map(td=>td.textContent.trim().toLowerCase()).join(' ');
                    const match = q === '' ? true : (text.indexOf(q) !== -1);
                    r.style.display = match ? '' : 'none';
                    const next = r.nextElementSibling;
                    if(next && next.querySelector('td') && next.querySelector('td').hasAttribute('colspan')){
                        next.style.display = match ? '' : 'none';
                    }
                });
                // After filtering: if grouping is active, rebuild groups using visible rows; otherwise clear any headers
                const groupColAttr = table.getAttribute('data-group-col');
                const groupingActive = groupColAttr && groupColAttr !== 'none';
                if(groupingActive){
                    try{ groupTable(tableId); }catch(e){ if(window.__DEBUG) console.error('groupTable error', e); }
                    // re-apply any active sort so ordering within groups is preserved
                    try{ applyCurrentSort(tableId); }catch(e){ if(window.__DEBUG) console.error('applyCurrentSort error', e); }
                } else {
                    clearGroupHeaders(tableId);
                }
                // After any filter action, refresh the visible sort indicators so
                // the visual glyph matches `aria-sort`. This avoids hiding the
                // indicator immediately after a user-initiated sort when grouping
                // is active (previous behavior cleared it).
                try{ refreshSortIndicators(tableId); }catch(e){}
            }catch(err){ if(window.__DEBUG) console.error('MBOM filter handler error', err); }
        });
        // also trigger filtering on these events to be more responsive
        try{
            input.addEventListener('keyup', function(){ input.dispatchEvent(new Event('input')); });
            input.addEventListener('change', function(){ input.dispatchEvent(new Event('input')); });
            input.addEventListener('paste', function(){ setTimeout(function(){ input.dispatchEvent(new Event('input')); }, 0); });
        }catch(e){ if(window.__DEBUG) console.warn('setupFilter: additional listeners failed', e); }
        // clear button if present
        const clearBtn = (tableId === 'breakersTable') ? document.getElementById('brkClearFilter') : document.getElementById('itemClearFilter');
        if(clearBtn){
            clearBtn.addEventListener('click', function(){
                input.value = '';
                input.dispatchEvent(new Event('input'));
                // if this is the breakers table, also clear grouping selection
                if (tableId === 'breakersTable') {
                    const sel = document.getElementById('brkGroupSelect');
                    if (sel) {
                        sel.value = 'none';
                        applyBreakersGrouping();
                    }
                }
            });
        }
    }

    function clearGroupHeaders(tableId){
        const table = document.getElementById(tableId);
        if(!table) return;
        const tbody = table.tBodies[0];
        if(!tbody) return;
        // remove any group header rows but do not modify row visibility (preserve filter state)
        Array.from(tbody.querySelectorAll('tr.group-header')).forEach(r=>r.remove());
        // If this table was annotated with original order, rebuild tbody in original order
        // This helps when grouping was active and removed/reordered rows; restoring grouping to 'none'
        // should put rows back in their original positions so clearing filters works.
        try{
            // detect original index on rows
            const anyRow = tbody.querySelector('tr');
            if(!anyRow) return;
            // Collect main rows (skip detail rows with colspan)
            const allRows = Array.from(tbody.querySelectorAll('tr'));
            const entries = [];
            for(let i=0;i<allRows.length;i++){
                const r = allRows[i];
                const firstTd = r.querySelector('td');
                if(!firstTd) continue;
                if(firstTd.hasAttribute('colspan')){
                    // attach as detail to previous entry
                    if(entries.length) entries[entries.length-1].detail = r;
                    continue;
                }
                const orig = r.getAttribute('data-orig-index');
                const idx = orig !== null ? parseInt(orig,10) : Number.MAX_SAFE_INTEGER;
                entries.push({orig: idx, row: r, detail: null});
            }
            // if none of the rows have orig indexes, nothing to do
            const hasOrig = entries.some(e=>isFinite(e.orig) && e.orig !== Number.MAX_SAFE_INTEGER);
            if(!hasOrig) return;
            entries.sort((a,b)=> a.orig - b.orig);
            // rebuild tbody preserving visibility states
            tbody.innerHTML = '';
            entries.forEach(e=>{
                tbody.appendChild(e.row);
                if(e.detail) tbody.appendChild(e.detail);
            });
        }catch(e){ if(window.__DEBUG) console.warn('clearGroupHeaders rebuild failed', e); }
    }

    function applyCurrentSort(tableId){
        const table = document.getElementById(tableId);
        if(!table) return;
        const thead = table.tHead;
        if(!thead) return;
        const ths = Array.from(thead.querySelectorAll('th'));
        for(const th of ths){
            const as = th.getAttribute('aria-sort');
            if(as){
                const colIdx = th.cellIndex;
                const asc = (as === 'ascending');
                try{ sortTable(tableId, colIdx, asc); }catch(e){}
                break;
            }
        }
    }

    function clearSortIndicators(tableId){
        const table = document.getElementById(tableId);
        if(!table) return;
        const thead = table.tHead;
        if(!thead) return;
        Array.from(thead.querySelectorAll('th')).forEach(function(th){
            const ind = th.querySelector('.sort-indicator');
            if(ind) ind.textContent = '';
            th.removeAttribute('aria-sort');
        });
    }

    // Refresh visual sort indicators to match each header's `aria-sort` state.
    // This keeps `aria-sort` for accessibility while restoring the glyph after
    // grouping/filter rebuilds (so sorting while grouped doesn't lose the arrow).
    function refreshSortIndicators(tableId){
        const table = document.getElementById(tableId);
        if(!table) return;
        const thead = table.tHead;
        if(!thead) return;
        Array.from(thead.querySelectorAll('th')).forEach(function(th){
            const ind = th.querySelector('.sort-indicator');
            const as = th.getAttribute('aria-sort');
            if(ind){
                if(as === 'ascending') ind.textContent = '\u25B2';
                else if(as === 'descending') ind.textContent = '\u25BC';
                else ind.textContent = '';
            }
        });
    }

    function applyBreakersGrouping(){
        const sel = document.getElementById('brkGroupSelect');
        const table = document.getElementById('breakersTable');
        if(!sel || !table) return;
        const val = sel.value;
        if(val === 'none'){
            table.setAttribute('data-group-col', 'none');
            const f = document.getElementById('brkFilter'); if(f) f.dispatchEvent(new Event('input'));
            // clear header sort indicators when toggling grouping
            try{ clearSortIndicators('breakersTable'); }catch(e){}
            return;
        }
        const map = { device: 2, brkPN: 4, cradlePN: 5, section: 6 };
        const idx = map[val] !== undefined ? map[val] : 2;
        table.setAttribute('data-group-col', idx);
        // re-run filter so visibility/group headers are updated (setupFilter will rebuild groups when appropriate)
        const f = document.getElementById('brkFilter'); if(f) f.dispatchEvent(new Event('input'));
        try{ clearSortIndicators('breakersTable'); }catch(e){}
    }

    function sortTable(tableId, colIndex, asc){
        const table = document.getElementById(tableId);
        if(!table) return;
        const tbody = table.tBodies[0];
        if(!tbody) return;
        const allRows = Array.from(tbody.querySelectorAll('tr'));
        // Build entries (main row + optional detail row)
        const entries = [];
        for(let i=0;i<allRows.length;i++){
            const r = allRows[i];
            if(r.classList && r.classList.contains('group-header')) continue;
            const firstTd = r.querySelector('td');
            if(!firstTd) continue;
            if(firstTd.hasAttribute('colspan')){
                // detail row: attach to previous entry if exists
                if(entries.length) entries[entries.length-1].detail = r;
                continue;
            }
            const key = getColText(r, colIndex);
            const next = r.nextElementSibling;
            let detail = null;
            if(next && next.querySelector('td') && next.querySelector('td').hasAttribute('colspan')) detail = next;
            entries.push({key: key, row: r, detail: detail});
        }

        // Check whether grouping is active for this table
        const groupColAttr = table.getAttribute('data-group-col');
        const groupingActive = groupColAttr && groupColAttr !== 'none';

        const compareFn = (a,b)=>{
            const an = parseFloat(a.key);
            const bn = parseFloat(b.key);
            if(!isNaN(an) && !isNaN(bn)) return asc ? an-bn : bn-an;
            if(a.key < b.key) return asc ? -1 : 1;
            if(a.key > b.key) return asc ? 1 : -1;
            return 0;
        };

        if(!groupingActive){
            // global sort
            // remove any existing group headers before rebuilding so grouping doesn't remain visible
            clearGroupHeaders(tableId);
            entries.sort(compareFn);
            // Rebuild tbody
            tbody.innerHTML = '';
            entries.forEach(e => {
                tbody.appendChild(e.row);
                if(e.detail) tbody.appendChild(e.detail);
            });
        } else {
            // group-aware sort: sort entries within each group only
            const groupCol = parseInt(groupColAttr,10);
            const groups = new Map();
            entries.forEach(ent => {
                const gkey = getColText(ent.row, groupCol) || 'Unassigned';
                if(!groups.has(gkey)) groups.set(gkey, []);
                groups.get(gkey).push(ent);
            });
            // sort group keys ascending (numeric when possible)
            const groupKeys = Array.from(groups.keys());
            groupKeys.sort((a,b)=>{
                const an = parseFloat(a);
                const bn = parseFloat(b);
                if(!isNaN(an) && !isNaN(bn)) return an - bn;
                if(a < b) return -1;
                if(a > b) return 1;
                return 0;
            });
            // sort each group's entries
            groupKeys.forEach(k => {
                groups.set(k, groups.get(k).sort(compareFn));
            });
            // Rebuild tbody by appending groups in sorted order
            tbody.innerHTML = '';
            groupKeys.forEach(k => {
                const arr = groups.get(k) || [];
                arr.forEach(e => {
                    tbody.appendChild(e.row);
                    if(e.detail) tbody.appendChild(e.detail);
                });
            });
            // reapply grouping headers (groupTable will insert headers where appropriate)
        }
        // Only re-apply grouping if grouping is active
        if(groupingActive){
            try{ groupTable(tableId); }catch(e){}
        }
    }

    function makeHeadersSortable(tableId){
        const table = document.getElementById(tableId);
        if(!table) return;
        const thead = table.tHead;
        if(!thead) return;
        let sortState = {};
        Array.from(thead.querySelectorAll('th')).forEach(function(th){
            th.style.cursor = 'pointer';
            // ensure there is an indicator span
            let ind = th.querySelector('.sort-indicator');
            if(!ind){
                ind = document.createElement('span');
                ind.className = 'sort-indicator';
                ind.style.marginLeft = '8px';
                ind.style.fontSize = '0.9em';
                th.appendChild(ind);
            }
            th.addEventListener('click', function(){
                const colIdx = th.cellIndex;
                const dir = sortState[colIdx] = !(sortState[colIdx] || false);
                // clear other indicators
                Array.from(thead.querySelectorAll('th')).forEach(function(other){
                    if(other === th) return;
                    const oind = other.querySelector('.sort-indicator');
                    if(oind) oind.textContent = '';
                    other.removeAttribute('aria-sort');
                });
                const indicator = th.querySelector('.sort-indicator');
                if(indicator) indicator.textContent = dir ? '\u25B2' : '\u25BC';
                th.setAttribute('aria-sort', dir ? 'ascending' : 'descending');
                try{
                    if(window.__DEBUG) console.log('sorting', tableId, colIdx, dir);
                    sortTable(tableId, colIdx, dir);
                }catch(err){
                    if(window.__DEBUG) console.error('sortTable error', err);
                }
                // re-run active filter so visibility/group headers are updated after sort
                // Only re-dispatch the filter when grouping is active; when no grouping is active
                // re-running the filter previously rebuilt original order and undid global sorts.
                const filterId = tableId === 'breakersTable' ? 'brkFilter' : (tableId === 'itemsTable' ? 'itemFilter' : null);
                if(filterId){
                    const inp = document.getElementById(filterId);
                    if(inp){
                        const t = document.getElementById(tableId);
                        const groupColAttr = t && t.getAttribute ? t.getAttribute('data-group-col') : null;
                        const groupingActive = groupColAttr && groupColAttr !== 'none';
                        if(groupingActive){ inp.dispatchEvent(new Event('input')); }
                    }
                }
            });
        });
    }

    // record original row order for each table so we can restore it when grouping is turned off
    function annotateOriginalOrder(tableId){
        const t = document.getElementById(tableId);
        if(!t) return;
        const tbody = t.tBodies[0];
        if(!tbody) return;
        let counter = 0;
        // mark each main row (skip detail rows) with an original index
        const rows = Array.from(tbody.querySelectorAll('tr'));
        for(let i=0;i<rows.length;i++){
            const r = rows[i];
            const td = r.querySelector('td');
            if(td && !td.hasAttribute('colspan')){
                r.setAttribute('data-orig-index', counter++);
                // if next row is a detail row, mark it with the same orig so it stays attached
                const next = r.nextElementSibling;
                if(next && next.querySelector('td') && next.querySelector('td').hasAttribute('colspan')){
                    next.setAttribute('data-orig-index', r.getAttribute('data-orig-index'));
                }
            }
        }
    }
    try{ annotateOriginalOrder('breakersTable'); }catch(e){}
    try{ annotateOriginalOrder('itemsTable'); }catch(e){}
    // initialize grouping and filters after we have original-order annotations
    try{ groupTable('breakersTable'); }catch(e){}
    try{ groupTable('itemsTable'); }catch(e){}
    // enable live filters
    try{ setupFilter('brkFilter','breakersTable'); }catch(e){}
    try{ setupFilter('itemFilter','itemsTable'); }catch(e){}
    makeHeadersSortable('breakersTable');
    makeHeadersSortable('itemsTable');
    // bind group select for breakers
    try{
        const gs = document.getElementById('brkGroupSelect');
        if(gs){
            gs.addEventListener('change', applyBreakersGrouping);
            // initialize to No Grouping on load
            if(!gs.value) gs.value = 'none';
            applyBreakersGrouping();
        }
    }catch(e){}
    window.__mbomGroupTables = function(){ try{ groupTable('breakersTable'); groupTable('itemsTable'); makeHeadersSortable('breakersTable'); makeHeadersSortable('itemsTable'); }catch(e){} };
});
</script>

<!-- Responsive-table-->
<script src="/public/plugins/RWD-Table-Patterns/dist/js/rwd-table.min.js"></script>
<script>
    $(function() {
        $('.table-responsive').responsiveTable({
            addDisplayAllBtn: 'btn btn-secondary'
        });
    });
</script>


<%- include('../partials/scripts') %>

<script>
    // Bind edit accessory modal save buttons (generated per-accessory) to call editBrkAcc(index)
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.edit-brk-acc-btn').forEach(function(btn){
            btn.addEventListener('click', function(ev){
                // prevent default form submission if editBrkAcc handles the action
                // allow it to proceed otherwise
                var idx = btn.getAttribute('data-index');
                if(typeof editBrkAcc === 'function'){
                    ev.preventDefault();
                    editBrkAcc(parseInt(idx, 10));
                }
            });
        });
    });
</script>
<script src="/public/assets/js/characterLimit.js"></script>
<script src="/public/assets/js/mbomCheckbox.js"></script>
<script src="/public/assets/js/mbomBreakerAccessories.js"></script>
<script src="/public/assets/js/mbomAccTooltips.js"></script>
<script src="/public/assets/js/mbomFilterDropdown.js"></script>
<script src="/public/assets/js/mbomDragDrop.js"></script>
</body>
</html>
