<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
  <!--
    Product.wxs - WiX installer template for Creo Automation
    Build-time vars required:
      -dProductVersion=...    (Product Version)
      -dSourceDir=...        (path to app files)
      -dMainExeId=...        (Id of the main exe file inside harvested .wxs)
  -->
  <Product Id="*"
           Name="Creo Automation"
           Language="1033"
           Version="$(var.ProductVersion)"
           Manufacturer="Xirro"
           UpgradeCode="D4A5B3E8-6C2F-4F1A-9B7D-0A1C2E3F4B5C">

    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine"/>
  <MajorUpgrade AllowDowngrades="no" AllowSameVersionUpgrades="yes" DowngradeErrorMessage="A newer version of [ProductName] is already installed."/>
  <!-- Request WiX embed cabinet into the MSI to avoid external .cab files at install time -->
  <MediaTemplate EmbedCab="yes"/>

    <!-- Directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="Creo Automation"/>
      </Directory>

      <!-- Start Menu shortcut folder (machine-wide CommonProgramsFolder for per-machine installs) -->
      <Directory Id="CommonProgramsFolder">
        <Directory Id="ApplicationProgramsFolder" Name="Creo Automation"/>
      </Directory>
    </Directory>

    <!-- Icon (SourceDir provided at build time) -->
    <Icon Id="AppIcon" SourceFile="$(var.SourceDir)\creo-automation.ico" />

    <!-- Features and harvested components -->
    <Feature Id="ProductFeature" Title="Creo Automation" Level="1">
      <ComponentGroupRef Id="AppComponents" />
      <ComponentRef Id="AppMenuCleanup" />
      <!-- Start menu shortcut component (references the harvested main exe via MainExeId provided at build time) -->
      <ComponentRef Id="ApplicationStartMenuShortcut" />
    </Feature>

    <!-- Cleanup component to remove Start Menu folder on uninstall (satisfies ICE64) -->
    <DirectoryRef Id="CommonProgramsFolder">
      <Component Id="AppMenuCleanup" Guid="*">
        <RemoveFolder Id="RemoveApplicationProgramsFolder" Directory="ApplicationProgramsFolder" On="uninstall" />
        <RegistryValue Root="HKLM" Key="Software\Xirro\CreoAutomation" Name="Installed" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>

    <!-- Component that creates a Start Menu shortcut pointing to the main executable. -->
    <DirectoryRef Id="ApplicationProgramsFolder">
      <Component Id="ApplicationStartMenuShortcut" Guid="*">
        <!-- Target uses the file id captured at build time (MainExeId) so the shortcut points to the installed exe. -->
        <Shortcut Id="ApplicationStartMenuShortcut.Lnk"
                  Name="Creo Automation"
                  Description="Launch Creo Automation"
                  Target="[#$(var.MainExeId)]"
                  WorkingDirectory="INSTALLFOLDER"
                  Icon="AppIcon"
                  IconIndex="0" />
        <!-- Registry key as component keypath (required to give the component a keypath) -->
        <RegistryValue Root="HKLM" Key="Software\Xirro\CreoAutomation" Name="StartMenuShortcut" Type="integer" Value="1" KeyPath="yes" />
      </Component>
    </DirectoryRef>

  </Product>
</Wix>