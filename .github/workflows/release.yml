# Build and publish release asset when a tag is pushed (e.g. v1.0.0)
#
# This workflow runs on Windows since the installer is a Windows executable.
# It checks out the repository, sets up Node, optionally runs `npm run build`,
# and uploads `./dist/CreoAutomationInstaller.exe` to the GitHub Release created for the tag.

name: Build and publish release asset

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-and-publish:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          if (Test-Path "package.json") { npm ci } else { Write-Host "No package.json found, skipping npm install" }

      - name: Run build (if defined)
        run: |
          # If you have a build script that produces an installer at ./dist/CreoAutomationInstaller.exe,
          # ensure package.json has a "build" script. This step will exit 0 if no build script exists.
          $pkg = Get-Content package.json -Raw | ConvertFrom-Json -ErrorAction SilentlyContinue
          if ($pkg -and $pkg.scripts -and $pkg.scripts.build) {
            Write-Host "Found build script, running npm run build"
            npm run build
          } else {
            Write-Host "No build script defined in package.json; skipping build step"
          }

      - name: Create GitHub release
        id: create_release
        uses: actions/create-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          release_name: ${{ github.ref_name }}
          body: |
            See CHANGELOG.md for release notes.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload CreoAutomationInstaller (if present)
        id: upload_asset
        uses: softprops/action-gh-release@v1
        with:
          files: dist/CreoAutomationInstaller.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify asset presence
        run: |
          if (Test-Path "./dist/CreoAutomationInstaller.exe") {
            Write-Host "CreoAutomationInstaller.exe found and uploaded"
          } else {
            Write-Host "No CreoAutomationInstaller.exe produced. If you want automatic upload, ensure your build creates ./dist/CreoAutomationInstaller.exe"
          }
