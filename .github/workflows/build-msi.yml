name: Build MSI

on:
  push:
    branches: [ main ]
    tags: ['v*']
  release:
    types: [ published ]
  workflow_dispatch:

jobs:
  build-msi:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up WiX
        run: |
          choco install wixtoolset --no-progress -y
        shell: powershell

      - name: Prepare environment
        run: |
          $version = ${{ github.ref_name }}
          if (-not $version) { $version = '1.0.0' }
          Write-Host "Building MSI version: $version"
          Set-Content -Path env:BUILD_VERSION -Value $version
        shell: powershell

      - name: Run MSI build
        run: |
          powershell -ExecutionPolicy Bypass -File installer\build-msi.ps1 -Version $env:BUILD_VERSION -SourceDir "dist" -OutDir "installer\output"
        shell: powershell

      - name: Upload artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: creo-msi
          path: installer\output\*.msi
